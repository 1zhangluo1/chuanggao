<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>创高fucker</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
  <!-- <script src='https://a.amap.com/jsapi_demos/static/citys.js'></script> -->
  <style>
    html,
    body,
    #container {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #container canvas.drawing {
      cursor: crosshair;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <div class="input-card" style="width: auto;">
    <div class="input-item">
      <button class="btn" onclick="startDrawing()">开始绘制</button>
      <button class="btn" style="margin-left: 10px;" onclick="redraw()">撤回</button>
    </div>
    <div class="input-item">
      <button class="btn" onclick="endDrawing()">结束绘制 (开环路线)</button>
    </div>
    <div class="input-item">
      <button class="btn" onclick="endCircle()">结束绘制 (路线闭合)</button>
    </div>
    <hr />
    <div class="input-item">
      <button class="btn" onclick="setLine(line1, false)">经典线路1</button>
    </div>
    <div class="input-item">
      <button class="btn" onclick="setLine(line2, true)">经典线路2</button>
    </div>
    <div class="input-item">
      <button class="btn" onclick="setLine(line3, true)">经典线路3</button>
    </div>
    <hr />
    <div class="input-item">
      <button class="btn" onclick="startRunning()">开始运动</button>
    </div>
  </div>
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=262b7e1b2838bb6efc7e6f1e6e11a2a6"></script>
  <script type="text/javascript" src="https://webapi.amap.com/loader.js"></script>
  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode: "68c811a338b080365092dc12d566930a",
    };
  </script>
  <script type="text/javascript">
    // 路线中的所有点集合 [(经度, 纬度)]
    var points = [];
    // 是否正在绘图中
    var isDrawing = false;
    // 是否定义为循环路线
    var isCircle = false;
    // html 页面中的主要元素
    var canvasMap;
    // 定义 marker 和 map
    var marker, map = new AMap.Map("container", {
      viewMode: '2D', // 默认使用 2D 模式
      zoom: 16, // 地图级别
      center: [104.000094, 30.557774], // 地图中心点
      mapStyle: "amap://styles/normal", // 设置地图的显示样式
    });
    // 创建起点终点的 Icon
    var startIcon = new AMap.Icon({
      size: new AMap.Size(25, 34), // 图标尺寸
      image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
      imageSize: new AMap.Size(135, 40), // 图标所用图片大小
      imageOffset: new AMap.Pixel(-9, -3) // 图标取图偏移量
    });
    var endIcon = new AMap.Icon({
      size: new AMap.Size(25, 34),
      image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
      imageSize: new AMap.Size(135, 40),
      imageOffset: new AMap.Pixel(-95, -3)
    });
    // 创建起点终点的 Marker
    var startMarker = new AMap.Marker({
      position: [0, 0],
      icon: startIcon,
      offset: new AMap.Pixel(-13, -30),
      title: "起点",
    });
    var endMarker = new AMap.Marker({
      position: [0, 0],
      icon: endIcon,
      offset: new AMap.Pixel(-13, -30),
      title: "终点",
    });
    // 路线图
    const polyline = new AMap.Polyline({
      path: [[0, 0]], // 设置线覆盖物路径
      strokeColor: "#f92472", // 线颜色
      strokeWeight: 5, // 线宽
      strokeStyle: "solid", // 线样式
      lineJoin: "round", // 折线拐点连接处样式
    });
    // 定义三条经典路线
    const line1 = [[103.996075, 30.554305], [103.995774, 30.554773], [103.995457, 30.555124], [103.995095, 30.555592], [103.994778, 30.556124], [103.994657, 30.556787], [103.994733, 30.557333], [103.994974, 30.557918], [103.995155, 30.558398], [103.995336, 30.558905], [103.995759, 30.559217], [103.996709, 30.559659], [103.997268, 30.55975], [103.997856, 30.559776], [103.998716, 30.559879], [103.999516, 30.560035], [104.00033, 30.560273], [104.001044, 30.560426], [104.001657, 30.560282], [104.002126, 30.559898], [104.00246, 30.559533], [104.002761, 30.559091], [104.003163, 30.558688], [104.003743, 30.558419], [104.004189, 30.558198], [104.004568, 30.558044], [104.004936, 30.557843], [104.00526, 30.557497], [104.005572, 30.55717], [104.005829, 30.556911], [104.006074, 30.556604], [104.006319, 30.556316], [104.006431, 30.556181], [104.005706, 30.555749], [104.005193, 30.555413], [104.004825, 30.555144], [104.0042, 30.554798], [104.003877, 30.554577], [104.003576, 30.554817], [104.003419, 30.555048], [104.003174, 30.555278], [104.003096, 30.555374], [104.002583, 30.555057], [104.002148, 30.554788], [104.001668, 30.554712], [104.001479, 30.554721], [104.001222, 30.554587], [104.001122, 30.554913], [104.000999, 30.555259], [104.000932, 30.555528], [104.000809, 30.555826], [104.000658, 30.556286], [104.000125, 30.555827], [103.999927, 30.555768], [103.999805, 30.555755], [103.999348, 30.555656], [103.998975, 30.555578], [103.998602, 30.555486], [103.998122, 30.555374], [103.997657, 30.555263], [103.997223, 30.555178], [103.996766, 30.555066], [103.996431, 30.554994], [103.996172, 30.554948], [103.996188, 30.55483]];
    const line2 = [[103.99692, 30.55268], [103.996891, 30.552789], [103.996857, 30.55286], [103.996846, 30.552936], [103.996814, 30.553025], [103.996804, 30.553093], [103.99677, 30.553179], [103.996766, 30.553266], [103.996738, 30.553334], [103.996722, 30.553412], [103.996698, 30.553492], [103.996687, 30.55355], [103.996687, 30.553645], [103.99674, 30.553746], [103.996808, 30.553793], [103.996882, 30.553853], [103.996962, 30.553876], [103.997064, 30.553896], [103.997141, 30.553892], [103.997214, 30.553881], [103.997307, 30.553853], [103.997373, 30.553789], [103.997428, 30.553734], [103.997481, 30.553641], [103.997505, 30.553484], [103.997557, 30.553345], [103.997602, 30.553188], [103.997616, 30.553119], [103.997665, 30.552979], [103.997695, 30.552829], [103.997687, 30.5527], [103.997616, 30.552617], [103.997555, 30.552561], [103.997491, 30.552525], [103.997394, 30.552496], [103.99728, 30.552484], [103.997172, 30.552498], [103.997093, 30.55252], [103.997019, 30.552564], [103.996944, 30.55266], [103.996905, 30.552775], [103.996877, 30.552854], [103.996836, 30.552924], [103.996811, 30.553003], [103.996789, 30.553097], [103.996783, 30.553183], [103.996752, 30.553264], [103.996725, 30.553338], [103.996708, 30.553399], [103.996693, 30.553467], [103.996679, 30.553529], [103.996678, 30.553607], [103.996706, 30.55366], [103.996732, 30.553711], [103.996761, 30.553749], [103.996807, 30.553804], [103.996891, 30.553842], [103.996945, 30.553861], [103.997016, 30.553879], [103.997098, 30.553886], [103.997173, 30.553876], [103.997243, 30.553865], [103.997296, 30.553843], [103.99733, 30.553817], [103.997363, 30.553788], [103.997401, 30.553749], [103.99743, 30.553703], [103.997452, 30.553648], [103.997464, 30.553608], [103.997479, 30.553548], [103.997484, 30.553516], [103.997512, 30.553438], [103.997539, 30.553371], [103.99756, 30.553302], [103.99757, 30.553229], [103.997597, 30.553168], [103.997618, 30.553077], [103.997637, 30.553037], [103.997652, 30.55296], [103.997662, 30.552925], [103.99768, 30.552853], [103.997682, 30.552786], [103.997676, 30.552732], [103.997665, 30.55269], [103.997641, 30.552625], [103.99759, 30.552574], [103.997538, 30.55254], [103.997491, 30.552513], [103.997413, 30.55249], [103.997316, 30.552475], [103.997235, 30.552478], [103.997169, 30.552483], [103.997108, 30.552505], [103.997033, 30.552545], [103.996996, 30.552574], [103.996976, 30.552603], [103.996948, 30.55264]];
    const line3 = [[104.005846, 30.557112], [104.005801, 30.557029], [104.005958, 30.556868], [104.006204, 30.556543], [104.006466, 30.556263], [104.006694, 30.555999], [104.006802, 30.555938], [104.006936, 30.555925], [104.00703, 30.55597], [104.007333, 30.556167], [104.007583, 30.55635], [104.00777, 30.556443], [104.007829, 30.556517], [104.007859, 30.55663], [104.007729, 30.556775], [104.007594, 30.556929], [104.007452, 30.557106], [104.007273, 30.55726], [104.007161, 30.557402], [104.00706, 30.557553], [104.00694, 30.557659], [104.00688, 30.557701], [104.006738, 30.557708], [104.006555, 30.557572], [104.006354, 30.557437], [104.006137, 30.557309], [104.005973, 30.557209]];

    function showPath(circled) {
      if (points.length >= 1) { // 如果存在起点
        startMarker.setPosition(points[0]);
        startMarker.show();
      }
      if (points.length >= 2) { // 两个点及以上
        if (circled) { // 路线为循环, 显示的时候把起点加上去
          polyline.setPath([...points, points[0]]);
        } else { // 路线不是循环
          polyline.setPath(points);
        }
        polyline.show();
      }
    }

    // 当页面完全加载时
    document.addEventListener("DOMContentLoaded", function() {
      canvasMap = document.getElementsByClassName("amap-layer")[0];
      // 将初始路线图添加到 map 中并隐藏, 以后就不用添加了
      map.add(polyline);
      polyline.hide();
      // 将起点终点添加到 map 中并隐藏
      map.add(startMarker);
      startMarker.hide();
      map.add(endMarker);
      endMarker.hide();
      // 点击地图事件
      map.on('click', function(e) {
        let position = e.lnglat; // 获取点击位置的经纬度坐标
        if (isDrawing) {
          points.push([position.lng, position.lat])
          console.log(JSON.stringify(points)) // 显示经纬度坐标
          showPath(false);
        }
      });
    });

    function startDrawing() {
      points = []; // 清空路线
      polyline.hide(); // 隐藏路线
      startMarker.hide(); // 隐藏起点
      endMarker.hide(); // 隐藏终点
      isDrawing = true;
      isCircle = false;
      canvasMap.classList.add("drawing");
    }

    function endDrawing() {
      if (points.length === 0) {
        return;
      }
      isCircle = false;
      isDrawing = false;
      showPath(isCircle);
      // 显示终点
      endMarker.setPosition(points[points.length - 1]);
      endMarker.show();
      canvasMap.classList.remove("drawing");
    }

    function endCircle() {
      if (points.length === 0) {
        return;
      }
      isCircle = true;
      isDrawing = false;
      showPath(isCircle);
      // 隐藏终点
      endMarker.hide();
      canvasMap.classList.remove("drawing");
    }

    function startRunning() {
      var data = { pointList: points, isCircle: isCircle };
      fetch('/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      }).then(response => {
        console.log('response:', response);
      }).catch((error) => {
        console.error('Error:', error);
      });
    }

    function redraw() {
      if (points.length === 0) {
        return;
      }
      points.pop(); // 撤回一个点
      endMarker.hide(); // 隐藏终点
      isDrawing = true;
      isCircle = false;
      showPath(isCircle);
      canvasMap.classList.add("drawing");
    }

    function setLine(_points, _isCircle) {
      startDrawing();
      points = _points;
      isCircle = _isCircle;
      if (isCircle) {
        endCircle();
      } else {
        endDrawing();
      }
    }
  </script>
</body>

</html>
